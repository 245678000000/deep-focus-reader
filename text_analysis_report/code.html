<!DOCTYPE html>
<!-- [DONE] FIX: Êé•ÂÖ• AI Ê®°ÂûãÂä®ÊÄÅÂàÜÊûêÊñáÁ´† - 2026-02-12 -->
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta name="description" content="Deep Focus Reader - AI ÊñáÊú¨ÂàÜÊûêÊä•Âëä" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìñ</text></svg>" />
<title>Deep Focus Reader - Text Analysis Report</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Spectral:wght@400;500;600;700&family=Crimson+Pro:wght@400;500;600&family=Noto+Serif+SC:wght@300;400;500&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>
<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          primary: "#2c2925",
          "background-light": "#f9f8f4",
          "background-dark": "#1a1918",
          "accent-gold": "#E8DCC5",
          "accent-sienna": "#C25E00",
          "accent-sienna-deep": "#88543B",
          "paper-texture": "#fdfbf7",
          "text-english": "#3A3530",
          "text-chinese": "#8C867D"
        },
        fontFamily: {
          display: ["Space Grotesk", "sans-serif"],
          english: ["Crimson Pro", "serif"],
          chinese: ["Noto Serif SC", "serif"],
          "serif-header": ["Spectral", "serif"]
        },
        borderRadius: { DEFAULT: "1rem", lg: "2rem", xl: "3rem", full: "9999px" },
        backgroundImage: {
          "paper-grain": "url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noiseFilter%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.65%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noiseFilter)%22 opacity=%220.04%22/%3E%3C/svg%3E')"
        }
      }
    }
  };
</script>
<style>
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  @keyframes spin-slow { to { transform: rotate(360deg); } }
  .animate-spin-slow { animation: spin-slow 2s linear infinite; }
  .level-ring { transition: stroke-dashoffset 1s ease-out; }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-primary min-h-screen flex flex-col transition-colors duration-300">

<nav class="sticky top-0 z-50 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-sm border-b border-primary/10 dark:border-white/10">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
    <div class="flex items-center gap-4">
      <a href="../index.html" class="p-2 hover:bg-primary/5 rounded-full transition-colors">
        <span class="material-icons-round text-primary/60 dark:text-white/60">arrow_back</span>
      </a>
      <div>
        <h1 class="text-sm font-medium tracking-wide uppercase text-primary/60 dark:text-white/60">AI Analysis Report</h1>
        <h2 id="reportTitle" class="text-lg font-serif-header font-bold text-primary dark:text-white">ËØ∑ÈÄâÊã©ÊñáÁ´†</h2>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <select id="articleSelect" class="rounded-xl border-primary/15 dark:border-white/20 bg-white/90 dark:bg-white/5 text-sm min-h-[44px]">
        <option value="">-- ÈÄâÊã©ÊñáÁ´† --</option>
      </select>
      <button id="analyzeBtn" class="min-h-[44px] px-5 rounded-xl bg-primary text-white text-sm font-medium hover:scale-105 active:scale-95 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
        <span class="material-icons-round text-base">auto_awesome</span>
        <span>AI ÂàÜÊûê</span>
      </button>
    </div>
  </div>
</nav>

<main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 py-8 w-full">
  <!-- Empty state -->
  <div id="emptyState" class="text-center py-20">
    <span class="material-icons-round text-7xl text-primary/15 dark:text-white/15">analytics</span>
    <p class="text-primary/50 dark:text-white/50 mt-4 text-lg">ÈÄâÊã©‰∏ÄÁØáÊñáÁ´†Âπ∂ÁÇπÂáª"AI ÂàÜÊûê"ÊåâÈíÆ</p>
    <p class="text-primary/35 dark:text-white/35 mt-2 text-sm">AI Â∞ÜÁîüÊàêÊñáÁ´†ÊëòË¶Å„ÄÅ‰∏ªÈ¢òÊèêÂèñ„ÄÅÈöæÂ∫¶ËØÑ‰º∞ÂíåÂ≠¶‰π†Âª∫ËÆÆ</p>
  </div>

  <!-- Loading state -->
  <div id="loadingState" class="hidden text-center py-20">
    <span class="material-icons-round text-6xl text-accent-sienna animate-spin-slow">autorenew</span>
    <p class="text-primary/70 dark:text-white/70 mt-4 text-lg">AI Ê≠£Âú®ÂàÜÊûêÊñáÁ´†...</p>
    <p class="text-primary/40 dark:text-white/40 mt-2 text-sm">È¢ÑËÆ°ÈúÄË¶Å 10-20 Áßí</p>
  </div>

  <!-- Report content -->
  <div id="reportContent" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6 sm:gap-8">
    <!-- Left: Summary + Themes (8 cols) -->
    <div class="lg:col-span-8 flex flex-col gap-6 sm:gap-8">
      <!-- Summary -->
      <section class="bg-white dark:bg-primary/5 p-6 sm:p-8 rounded-2xl border border-primary/5 dark:border-white/10 shadow-sm relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-accent-sienna/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
        <div class="relative z-10">
          <div class="flex items-center gap-3 mb-6">
            <span class="bg-primary/10 dark:bg-white/10 text-primary dark:text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">Synopsis</span>
            <span class="text-primary/40 dark:text-white/40 text-xs">Generated by AI</span>
          </div>
          <div id="summaryText" class="font-english text-lg sm:text-xl leading-relaxed text-primary/80 dark:text-white/80 space-y-4"></div>
          <div id="summaryTextCn" class="mt-4 font-chinese text-base leading-relaxed text-text-chinese dark:text-white/60 space-y-3"></div>
        </div>
      </section>

      <!-- Themes + Cognitive -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-primary/5 p-6 rounded-2xl border border-primary/5 dark:border-white/10 shadow-sm">
          <h4 class="font-serif-header text-xl dark:text-white mb-4 flex items-center gap-2">
            <span class="material-icons-round text-accent-sienna text-lg">local_offer</span> Key Themes
          </h4>
          <div id="themeTags" class="flex flex-wrap gap-2"></div>
        </div>
        <div class="bg-white dark:bg-primary/5 p-6 rounded-2xl border border-primary/5 dark:border-white/10 shadow-sm">
          <h4 class="font-serif-header text-xl dark:text-white mb-4 flex items-center gap-2">
            <span class="material-icons-round text-accent-sienna text-lg">psychology</span> Cognitive Load
          </h4>
          <div id="cognitiveMetrics" class="space-y-4"></div>
        </div>
      </section>

      <!-- Key Vocabulary -->
      <section class="bg-white dark:bg-primary/5 p-6 rounded-2xl border border-primary/5 dark:border-white/10 shadow-sm">
        <h4 class="font-serif-header text-xl dark:text-white mb-4 flex items-center gap-2">
          <span class="material-icons-round text-accent-sienna text-lg">spellcheck</span> Key Vocabulary / Ê†∏ÂøÉËØçÊ±á
        </h4>
        <div id="keyVocabulary" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
      </section>
    </div>

    <!-- Right: Level + Recommendation (4 cols) -->
    <div class="lg:col-span-4 flex flex-col gap-6">
      <!-- Level -->
      <div class="bg-primary text-white p-8 rounded-2xl shadow-xl relative overflow-hidden flex flex-col items-center text-center">
        <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(circle at 2px 2px, white 1px, transparent 0); background-size: 24px 24px;"></div>
        <h4 class="font-display uppercase tracking-widest text-xs opacity-60 mb-6 relative z-10">Lexical Complexity</h4>
        <div class="relative w-40 h-40 flex items-center justify-center mb-6 z-10">
          <svg class="w-full h-full transform -rotate-90">
            <circle class="text-white/10" cx="80" cy="80" fill="transparent" r="70" stroke="currentColor" stroke-width="8"></circle>
            <circle id="levelRing" class="level-ring text-white" cx="80" cy="80" fill="transparent" r="70" stroke="currentColor" stroke-dasharray="440" stroke-dashoffset="440" stroke-width="8"></circle>
          </svg>
          <div class="absolute flex flex-col items-center">
            <span id="levelLabel" class="text-5xl font-serif-header font-bold">--</span>
            <span id="levelDesc" class="text-xs uppercase tracking-wide opacity-80 mt-1">Analyzing</span>
          </div>
        </div>
        <div id="readTimeInfo" class="flex gap-2 text-sm opacity-80 relative z-10">
          <span class="material-icons-round text-base">timer</span>
          <span>-- min read</span>
        </div>
      </div>

      <!-- Recommendation -->
      <div class="bg-white dark:bg-primary/5 p-6 rounded-2xl border border-primary/5 dark:border-white/10 shadow-sm flex-grow">
        <h4 class="font-serif-header text-xl dark:text-white mb-4 flex items-center gap-2">
          <span class="material-icons-round text-accent-sienna text-lg">lightbulb</span> Learning Tips
        </h4>
        <div id="learningTips" class="space-y-3"></div>
      </div>

      <!-- Actions -->
      <div class="flex flex-col gap-3">
        <a id="startReadingBtn" href="#" class="min-h-[44px] rounded-xl bg-primary dark:bg-white dark:text-primary text-white text-sm font-medium flex items-center justify-center gap-2 hover:scale-105 active:scale-95 transition-all shadow-lg">
          <span class="material-icons-round text-base">menu_book</span>
          <span>ÂºÄÂßãÈòÖËØªÊ≠§ÊñáÁ´†</span>
        </a>
        <a id="grammarBtn" href="#" class="min-h-[44px] rounded-xl border border-primary/15 dark:border-white/20 text-sm flex items-center justify-center gap-2 hover:bg-primary/5 dark:hover:bg-white/10 transition-all">
          <span class="material-icons-round text-base">rule</span>
          <span>ËØ≠Ê≥ïÂàÜÊûê</span>
        </a>
      </div>
    </div>
  </div>
</main>

<a href="../index.html" class="fixed bottom-20 right-4 md:bottom-5 md:right-5 z-50 min-h-[44px] px-4 rounded-full bg-primary text-white text-sm shadow-lg hover:scale-105 active:scale-95 transition-all flex items-center">Hub</a>
<nav class="fixed bottom-0 left-0 right-0 md:hidden bg-white/90 dark:bg-[#23211e]/90 backdrop-blur border-t border-primary/10 dark:border-white/10 flex justify-around py-2 z-50">
  <a href="../library_dashboard/code.html" class="min-h-[44px] min-w-[44px] flex items-center justify-center text-primary/60"><span class="material-icons-round">library_books</span></a>
  <a href="../the_study_reading_view/code.html" class="min-h-[44px] min-w-[44px] flex items-center justify-center text-primary/60"><span class="material-icons-round">auto_stories</span></a>
  <a href="../vocabulary_insights_sidebar/code.html" class="min-h-[44px] min-w-[44px] flex items-center justify-center text-primary/60"><span class="material-icons-round">school</span></a>
  <a href="../ingest_and_analysis_modal/code.html" class="min-h-[44px] min-w-[44px] flex items-center justify-center text-primary/60"><span class="material-icons-round">upload_file</span></a>
</nav>

<script>
(function () {
  const AI_PROXY = "/api/ai-proxy";
  const AI_DIRECT = "https://integrate.api.nvidia.com/v1/chat/completions";
  const AI_KEY = "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";
  const AI_MODEL = "minimaxai/minimax-m2.1";

  const theme = localStorage.getItem("dfr_theme");
  if (theme === "dark") document.documentElement.classList.add("dark");

  const articleSelect = document.getElementById("articleSelect");
  const analyzeBtn = document.getElementById("analyzeBtn");
  const reportTitle = document.getElementById("reportTitle");
  const emptyState = document.getElementById("emptyState");
  const loadingState = document.getElementById("loadingState");
  const reportContent = document.getElementById("reportContent");

  const summaryText = document.getElementById("summaryText");
  const summaryTextCn = document.getElementById("summaryTextCn");
  const themeTags = document.getElementById("themeTags");
  const cognitiveMetrics = document.getElementById("cognitiveMetrics");
  const keyVocabulary = document.getElementById("keyVocabulary");
  const levelRing = document.getElementById("levelRing");
  const levelLabel = document.getElementById("levelLabel");
  const levelDesc = document.getElementById("levelDesc");
  const readTimeInfo = document.getElementById("readTimeInfo");
  const learningTips = document.getElementById("learningTips");
  const startReadingBtn = document.getElementById("startReadingBtn");
  const grammarBtn = document.getElementById("grammarBtn");

  let currentArticleId = "";
  const reportCache = new Map();

  function escapeHtml(t) { return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

  function loadArticles() {
    const articles = [];
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (k && k.startsWith("article_")) {
        try {
          const d = JSON.parse(localStorage.getItem(k));
          articles.push({ id: k, title: d.title || "Untitled", text: d.text || "" });
        } catch (_e) {}
      }
    }
    return articles.sort((a, b) => b.id.localeCompare(a.id));
  }

  function populateSelect() {
    const articles = loadArticles();
    articleSelect.innerHTML = '<option value="">-- ÈÄâÊã©ÊñáÁ´† --</option>';
    articles.forEach((a) => {
      const opt = document.createElement("option");
      opt.value = a.id;
      opt.textContent = a.title.length > 35 ? a.title.slice(0, 35) + "..." : a.title;
      articleSelect.appendChild(opt);
    });
  }

  articleSelect.addEventListener("change", () => {
    const id = articleSelect.value;
    analyzeBtn.disabled = !id;
    if (id) {
      try {
        const d = JSON.parse(localStorage.getItem(id));
        reportTitle.textContent = d?.title || "Untitled";
      } catch (_e) { reportTitle.textContent = "Untitled"; }
    } else {
      reportTitle.textContent = "ËØ∑ÈÄâÊã©ÊñáÁ´†";
    }
  });

  analyzeBtn.addEventListener("click", async () => {
    const id = articleSelect.value;
    if (!id) return;
    currentArticleId = id;

    let articleData;
    try { articleData = JSON.parse(localStorage.getItem(id)); } catch (_e) { return; }
    const text = articleData?.text || "";
    if (!text) return;

    // Show loading
    emptyState.classList.add("hidden");
    reportContent.classList.add("hidden");
    loadingState.classList.remove("hidden");
    analyzeBtn.disabled = true;

    try {
      let report;
      if (reportCache.has(id)) {
        report = reportCache.get(id);
      } else {
        report = await callAI(text);
        reportCache.set(id, report);
      }
      renderReport(report, articleData);
    } catch (err) {
      loadingState.classList.add("hidden");
      emptyState.classList.remove("hidden");
      emptyState.innerHTML = '<span class="material-icons-round text-6xl text-red-300">error</span><p class="text-red-500 mt-4">AI ÂàÜÊûêÂ§±Ë¥•Ôºö' + escapeHtml(err.message) + '</p><p class="text-primary/40 mt-2 text-sm">ËØ∑Á®çÂêéÈáçËØï</p>';
    } finally {
      analyzeBtn.disabled = !articleSelect.value;
    }
  });

  async function callAI(text) {
    // Truncate to ~3000 chars for API
    const truncated = text.length > 3000 ? text.slice(0, 3000) + "..." : text;

    const systemPrompt = `You are an English text analysis assistant for Chinese ESL learners. Analyze the given English text and return a JSON object:
{
  "summary": "2-3 sentence English summary of the text",
  "summaryCn": "‰∏≠ÊñáÊëòË¶ÅÔºå100Â≠óÂ∑¶Âè≥",
  "themes": ["theme1", "theme2", "theme3", "theme4", "theme5"],
  "cefrLevel": "A1/A2/B1/B2/C1/C2",
  "cefrLevelDesc": "Beginner/Elementary/Intermediate/Upper-Intermediate/Advanced/Proficiency",
  "readTimeMinutes": 8,
  "avgSentenceLength": 18,
  "sentenceLengthLevel": "Low/Medium/High",
  "conceptDensity": "Low/Medium/High",
  "conceptDensityPercent": 60,
  "keyVocabulary": [
    {"word": "word", "pos": "noun/verb/adj", "definition": "English definition", "definitionCn": "‰∏≠ÊñáÈáä‰πâ"}
  ],
  "learningTips": ["tip1 in Chinese", "tip2 in Chinese", "tip3 in Chinese"],
  "coreVocabPercent": 65,
  "academicVocabPercent": 25,
  "rareVocabPercent": 10,
  "academicExamples": ["word1", "word2", "word3"]
}
Only output valid JSON, no markdown code fences, no extra text. keyVocabulary should have 6-10 important words.`;

    const payload = {
      model: AI_MODEL,
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: truncated }
      ],
      temperature: 0.3,
      max_tokens: 2048
    };

    // Try proxy first (for Vercel deployment), then direct (for local)
    let resp;
    try {
      resp = await fetch(AI_PROXY, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
    } catch (_e) {
      resp = await fetch(AI_DIRECT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + AI_KEY
        },
        body: JSON.stringify(payload)
      });
    }

    if (!resp.ok) throw new Error("AI API HTTP " + resp.status);
    const data = await resp.json();
    let content = (data?.choices?.[0]?.message?.content || "").trim();
    // Strip thinking tags and markdown code fences
    content = content.replace(/<think>[\s\S]*?<\/think>/gi, "").trim();
    content = content.replace(/^```(?:json)?\s*/i, "").replace(/\s*```$/i, "").trim();
    return JSON.parse(content);
  }

  function renderReport(r, articleData) {
    loadingState.classList.add("hidden");
    reportContent.classList.remove("hidden");

    // Summary
    summaryText.innerHTML = "<p>" + escapeHtml(r.summary || "") + "</p>";
    summaryTextCn.innerHTML = "<p>" + escapeHtml(r.summaryCn || "") + "</p>";

    // Themes
    themeTags.innerHTML = "";
    (r.themes || []).forEach((t) => {
      const span = document.createElement("span");
      span.className = "px-4 py-2 bg-background-light dark:bg-primary/20 border border-primary/10 dark:border-white/15 rounded-full text-sm font-medium hover:border-accent-sienna/50 hover:text-accent-sienna transition-colors cursor-default";
      span.textContent = t;
      themeTags.appendChild(span);
    });

    // Cognitive
    const slPct = r.sentenceLengthLevel === "High" ? 85 : r.sentenceLengthLevel === "Medium" ? 55 : 30;
    cognitiveMetrics.innerHTML = `
      <div>
        <div class="flex justify-between items-center text-sm"><span class="text-primary/70 dark:text-white/70">Sentence Length</span><span class="font-bold dark:text-white">${r.sentenceLengthLevel || "Medium"} (Avg. ${r.avgSentenceLength || "--"} words)</span></div>
        <div class="w-full bg-primary/5 dark:bg-white/10 rounded-full h-2 overflow-hidden mt-2"><div class="bg-accent-sienna-deep h-2 rounded-full" style="width:${slPct}%"></div></div>
      </div>
      <div>
        <div class="flex justify-between items-center text-sm pt-2"><span class="text-primary/70 dark:text-white/70">Concept Density</span><span class="font-bold dark:text-white">${r.conceptDensity || "Medium"}</span></div>
        <div class="w-full bg-primary/5 dark:bg-white/10 rounded-full h-2 overflow-hidden mt-2"><div class="bg-primary/40 h-2 rounded-full" style="width:${r.conceptDensityPercent || 50}%"></div></div>
      </div>
    `;

    // Key Vocabulary
    keyVocabulary.innerHTML = "";
    (r.keyVocabulary || []).forEach((v) => {
      const div = document.createElement("div");
      div.className = "rounded-xl border border-primary/10 dark:border-white/10 bg-background-light dark:bg-primary/10 p-3";
      div.innerHTML = `
        <div class="flex items-baseline gap-2">
          <span class="font-english font-semibold text-primary dark:text-white">${escapeHtml(v.word)}</span>
          <span class="text-xs text-primary/50 dark:text-white/50 italic">${escapeHtml(v.pos || "")}</span>
        </div>
        <p class="text-xs text-primary/70 dark:text-white/70 mt-1">${escapeHtml(v.definition || "")}</p>
        <p class="text-xs font-chinese text-text-chinese dark:text-white/50 mt-0.5">${escapeHtml(v.definitionCn || "")}</p>
      `;
      keyVocabulary.appendChild(div);
    });

    // Level ring
    const levelMap = { A1: 73, A2: 147, B1: 220, B2: 294, C1: 367, C2: 440 };
    const dashOffset = 440 - (levelMap[r.cefrLevel] || 220);
    levelRing.style.strokeDashoffset = String(dashOffset);
    levelLabel.textContent = r.cefrLevel || "--";
    levelDesc.textContent = r.cefrLevelDesc || "Unknown";
    readTimeInfo.innerHTML = '<span class="material-icons-round text-base">timer</span><span>' + (r.readTimeMinutes || "--") + ' min read</span>';

    // Learning tips
    learningTips.innerHTML = "";
    (r.learningTips || []).forEach((tip) => {
      const div = document.createElement("div");
      div.className = "rounded-xl bg-background-light dark:bg-primary/20 p-3 flex gap-3 items-start";
      div.innerHTML = '<span class="material-icons-round text-accent-sienna text-base mt-0.5 shrink-0">lightbulb</span><p class="text-sm font-chinese text-primary/80 dark:text-white/70 leading-relaxed">' + escapeHtml(tip) + '</p>';
      learningTips.appendChild(div);
    });

    // Links
    const aid = currentArticleId;
    startReadingBtn.href = "../the_study_reading_view/code.html?article=" + encodeURIComponent(aid);
    grammarBtn.href = "../grammar_analysis_popover/code.html?article=" + encodeURIComponent(aid);
  }

  // Init
  populateSelect();
  const params = new URLSearchParams(window.location.search);
  const articleId = params.get("article");
  if (articleId) {
    articleSelect.value = articleId;
    articleSelect.dispatchEvent(new Event("change"));
  }
})();
</script>
</body>
</html>
